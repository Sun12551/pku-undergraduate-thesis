% Copyright (c) 2014,2016 Casper Ti. Vector
% Public domain.

\chapter{背景}
%\pkuthssffaq % 中文测试文字。
\section{exFTA文件系统}
exFAT (Extended File Allocation Table)\parencite{exFAT} 是由微软公司开发的一种文件系统，
专为闪存存储，如USB闪存驱动器、SD卡和CF卡等设计。作为FAT32的后继文件系统，
exFAT 主要解决了FAT32在处理大文件和大容量存储设备上的限制。具体来说，
exFAT 文件系统使用64位来描述文件大小，从而支持依赖于非常大的文件的应用程序；
exFAT 文件系统还允许最大32MB的簇，有效地支持了非常大的存储设备。

exFAT文件系统在存储设备上的分区可以划分为三个主要部分：启动区、FAT区和数据区，如图？？所示。
启动区包含超级块和后备超级块。
超级块（Superblock）中包含文件系统的基本信息，如扇区和簇的大小、FAT区和数据区的位置，、根目录所在簇等。
超级块一般位于存储设备上 exFAT 分区的起始位置，会在exFAT打开时被读取。
利用超级块中的信息，操作系统可以读取文件分配表并初始化根目录。
超级块对 exFAT 文件系统非常重要，因此还会安排一个后备超级块（Backup Superblock），以应对超级块损坏的情况。
如果超级块和后备超级块都损坏了，exFTA 文件系统将无法被挂载。

exFAT 将数据区里存储文件的部分（一般被称为簇堆，Cluster Heap）划分为一系列的簇（Cluster），
一个簇一般包含若干扇区。
扇区是存储设备的最小读写单元，而簇是文件分配的最小单元，即块设备上逻辑存储的基本单位。
作为FAT文件系统家族中的一员， exFAT 也使用文件分配表（FAT，File Allocation Table）来组织文件。
文件分配表描述了簇和文件内容之间链接关系，位于启动区之后的FAT区。
一个文件可能由若干簇组成，这些簇组成了一个簇链。
对于使用FAT的分配方式，文件分配表中维护了当前簇的下一个簇的编号。
这种组织结构类似链表，如果将一个文件中的一系列簇视作一个链表，
文件分配表中的条目相当于链表结构中的 Next 指针。
在读取某个文件时，通过查找文件分配表可以依次找到文件在磁盘上对应的各个簇的编号，从而访问文件的内容。
出于某些历史上的原因， exFAT 的簇编号从 2 开始，也就是说，假设数据区一共包括 $ N $ 个簇，第一个簇的编号是 2，
最后一个簇的编号是 $ N + 1 $。若从文件分配表中得到某个合法的簇编号 $ C $，该簇的物理编号是 $ C - 2 $。

数据区则是用于存储用户的文件和文件夹的区域，exFAT 文件系统内的所有文件和文件夹（包括根目录和系统文件）
的数据都存储在这个区域，并使用文件分配表来进行组织。
exFAT使用目录树结构来管理存于簇堆中的文件系统结构和文件。
在目录树中，父目录与子目录之间存在一对多的关系。
超级块中记录了文件系统的根目录所在簇，所有其他的目录都以单链方式从根目录派生。
每个目录由一系列目录项（Directory entry，在本文中简称为Dentry）组成，exFAT中的单个目录项的大小固定为32字节。
事实上，exFAT内的目录文件的文件内容就是一系列目录项。
一个或多个目录项可以组成一个目录项集（Directory entry set，在本文中简称为Dentry set），
用于描述文件系统结构，子目录或文件。

每一个有效的目录项可以按照属于主目录项或次目录项、属于关键目录项还是可选目录项分为四类。
每一个目录项集都是由一个主目录项和一系列次目录项组成，主目录项中会指明相关联的次目录项的个数。
关键主目录项包含一些对于exFAT文件系统的正确管理至关重要的信息，所有这种类型的目录项都应当被实现。
可选主目录项的实现是可选的，这类目录项的作用是辅助管理文件系统，我们的实现中暂时并未支持这类目录项。
关键次目录项包含管理其所在目录项集的关键信息，虽然对任何关键次目录项的支持是可选的，但一个未识别的
关键目录项会使整个目录项集无法识别，我们的实现还是支持了exFAT标准中出现的所有关键次目录项。
可选次目录项的实现也是可选的，一个目录项集中出现的未识别的可选次目录项可以被忽略。
除此之外，exFAT 还定义了两种无效的目录项：未使用的目录项（Unused）和被删除的目录项（Deleted）。
表\ref{tab:dentry}中列出了我们的实现中主要的Dentry类型。
\begin{table}[h]
    \centering
    \begin{tabularx}{\textwidth}{|c|c|Y|}
    \hline
    Dentry类型 & 种类 & 描述 \\
    \hline
    Bitmap & 关键主目录项 & 与系统文件 Bitmap 关联的目录项，位于根目录中，没有次目录项，Bitmap用于跟踪磁盘上的空闲簇和已分配簇\\
    \hline
    Upcase Table & 关键主目录项 & 与系统文件大写转换表（Upcase Table）关联的目录项，位于根目录中，没有次目录项，大写转换表用于支持exFAT对大小写不敏感的特性\\
    \hline
    File & 关键主目录项 & 描述文件和目录的信息，合法的 File 目录项后会跟着一个 Stream 目录项和至少一个 Name 目录项\\
    \hline
    Stream & 关键次目录项 & 补充描述文件和目录的信息，紧跟 File 目录项出现\\
    \hline
    Name & 关键次目录项 & 记录相关文件和目录的名称，紧跟 Stream 目录项出现\\
    \hline
    Vendor Extension & 可选次目录项 & 文件供应商自定义目录项，只能出现在 Stream 和 Name 目录项之后\\
    \hline
    Vendor Allocation & 可选次目录项 & 文件供应商自定义目录项，只能出现在 Stream 和 Name 目录项之后\\
    \hline
    Unused & - & 未使用的目录项，只能出现在所在目录的末尾\\
    \hline
    Deleted & - & 被删除的目录项\\
    \hline
    \end{tabularx}
    \caption{Dentry 类型}
    \label{tab:dentry}
\end{table}



\section{页缓存及数据预取}
页缓存（Page Cache）是一种计算机系统常用的用于加速数据访问的技术。利用应用程序访问数据的局部性特点，
通过将常用的文件的数据缓存至内存，从而加速对文件数据的访问。数据预取（Readahead）则是一种预测性的技术，
它根据应用过去的访问模式来预测未来可能需要的数据，并提前从磁盘上读取这些数据到页缓存中。当这些数据
真正被访问时，它们已经在内存中可用，从而避免了磁盘访问的延迟。
因此，对于有明显访问模式的应用（如顺序访问），数据预取可以显著提高应用程序的性能。
本文主要关注顺序访问模式，为Asterinas的页缓存实现了数据预取。

% vim:ts=4:sw=4
